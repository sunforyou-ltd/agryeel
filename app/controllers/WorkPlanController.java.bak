package controllers;

import java.text.DecimalFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import models.Account;
import models.Attachment;
import models.Belto;
import models.Common;
import models.Compartment;
import models.CompartmentStatus;
import models.CompartmentWorkChainStatus;
import models.Crop;
import models.FieldGroup;
import models.Hinsyu;
import models.Kiki;
import models.MotochoBase;
import models.Nisugata;
import models.Nouhi;
import models.PlanLine;
import models.SaibaiPlanGoal;
import models.Sequence;
import models.Shitu;
import models.Size;
import models.TimeLine;
import models.Work;
import models.WorkChainItem;
import models.WorkDiary;
import models.WorkPlan;
import models.WorkPlanDetail;
import models.WorkPlanSanpu;

import play.Logger;
import play.libs.Json;
import play.mvc.Controller;
import play.mvc.Result;
import play.mvc.Security;
import util.DateU;
import util.StringU;
import views.html.workplan;

import com.avaje.ebean.Ebean;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

import compornent.FieldComprtnent;
import compornent.MonthWeekList;
import compornent.SessionCheckComponent;
import compornent.UserComprtnent;
import consts.AgryeelConst;

public class WorkPlanController extends Controller {

    /**
     * 【AICA】作業指示画面への遷移
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result move() {
        return ok(views.html.workplan.render());
    }
    /**
     * 【AICA】作業指示画面への遷移
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result accountmove() {
        return ok(views.html.workplanaccount.render());
    }
    /**
     * 【AICA】作業指示書の取得
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result getWorkPlan(String targetDate, String accountId, double crop) {

      ObjectNode resultJson   = Json.newObject();
      ObjectNode dateList     = Json.newObject();
      ObjectNode workList     = Json.newObject();
      ObjectMapper mapper     = new ObjectMapper().enable(SerializationFeature.INDENT_OUTPUT);
      ArrayNode listJsonApi   = mapper.createArrayNode();
      boolean api             = false;

      //----------------------------------------------------------------------------
      //- 作業指示書を取得する
      //----------------------------------------------------------------------------
      SimpleDateFormat sdfp = new SimpleDateFormat("yyyyMMdd");
      SimpleDateFormat sdff = new SimpleDateFormat("yyyy/MM/dd");
      SimpleDateFormat sdf  = new SimpleDateFormat("MM.dd HH:mm");
      SimpleDateFormat sdf2 = new SimpleDateFormat("MM/dd");
      SimpleDateFormat sdff2 = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss");

      Calendar system   = Calendar.getInstance();
      Calendar start    = Calendar.getInstance();
      Calendar end      = Calendar.getInstance();
      try {

        Calendar cal = Calendar.getInstance();
        long to   = cal.getTime().getTime();

        system.setTime(sdfp.parse(targetDate));
        int dIdx = 0;
        for (int i = 0; i < 7; i++) {
          dIdx++;
          ObjectNode dateJson = Json.newObject();
          dateJson.put("date"     , sdff.format(system.getTime()));
          dateJson.put("dtwk"     , DateU.getDayOfWeek(system));
          dateJson.put("keydate"  , sdfp.format(system.getTime()));
          dateList.put(String.valueOf(dIdx), dateJson);
          system.add(Calendar.DAY_OF_MONTH, 1);
        }

        start.setTime(sdfp.parse(targetDate));
        end.setTime(sdfp.parse(targetDate));

        if (session(AgryeelConst.SessionKey.API) != null) {
          api = true;
        }
        else {
          end.add(Calendar.DAY_OF_MONTH, 7);
        }

        UserComprtnent ac = new UserComprtnent();
        ac.GetAccountData(session(AgryeelConst.SessionKey.ACCOUNTID));
        String sAccountId = AgryeelConst.SpecialAccount.ALLACOUNT;

        if (!accountId.equals("")) {
          sAccountId = accountId;
        }

        List<PlanLine> pls = PlanLine.getPlanLineOfAccount(accountId, ac.accountData.farmId, start.getTime(), end.getTime());
        int idx = 0;

        for (PlanLine planLineData : pls) {                                        //作業情報をJSONデータに格納する
          CompartmentStatus compartmentStatusData = FieldComprtnent.getCompartmentStatus(planLineData.kukakuId);
          CompartmentWorkChainStatus cws          = compartmentStatusData.getWorkChainStatus();
          if (crop != 0 && crop != cws.cropId) {
            continue;
          }

          WorkPlan wp = WorkPlan.find.where().eq("work_plan_id", planLineData.workPlanId).findUnique();

          if (wp == null) { continue; }

          ObjectNode timeLineJson         = Json.newObject();
          timeLineJson.put("workPlanId"   , planLineData.workPlanId);                   //作業計画ID
          timeLineJson.put("workdate"     , sdf2.format(wp.workDate));                  //作業日
          timeLineJson.put("keydate"      , sdfp.format(wp.workDate));                  //キー作業日
          timeLineJson.put("message"      , StringU.setNullTrim(planLineData.message)); //メッセージ
          timeLineJson.put("timeLineColor", planLineData.planLineColor);                //タイムラインカラー
          timeLineJson.put("workName"     , planLineData.workName);                     //作業名
          timeLineJson.put("kukakuName"   , planLineData.kukakuName);                   //区画名
          timeLineJson.put("accountId"    , planLineData.accountId);                    //アカウントID
          timeLineJson.put("accountName"  , planLineData.accountName);                  //アカウント名
          timeLineJson.put("workId"       , planLineData.workId);                       //作業ＩＤ
          timeLineJson.put("worktime"     , wp.workTime);                               //作業時間
          timeLineJson.put("kukakuId"     , planLineData.kukakuId);                     //区画ＩＤ
          Compartment cpt = Compartment.getCompartmentInfo(planLineData.kukakuId);
          timeLineJson.put("fieldId"      , cpt.fieldId);                               //圃場ID
          timeLineJson.put("end"          , AgryeelConst.WORKPLANEND.WORKPLAN);         //作業完了フラグ
          timeLineJson.put("workPlanFlag" , planLineData.workPlanFlag);                 //作業計画フラグ
          timeLineJson.put("uuidofday"    , planLineData.uuidOfDay);                    //同一日内指示番号
          if (planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKDIARYWATCH
              || planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKPLANWATCH
              || planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.AICAPLANWATCH) {//作業中の場合

            long from = wp.workStartTime.getTime();
            long diff = ( to - from  ) / (1000 * 60 );
            timeLineJson.put("worktime"     , diff);                                    //作業時間を書き換える

          }
          if(api){
            FieldGroup fg = cpt.getFieldGroupInfo();
            timeLineJson.put("kukakuColor", fg.fieldGroupColor);                        //区画カラー
          }

          idx++;
          workList.put(Double.toString(idx), timeLineJson);
          listJsonApi.add(timeLineJson);

        }

        List<TimeLine> tls = TimeLine.getTimeLineOfAccount(accountId, ac.accountData.farmId, start.getTime(), end.getTime());

        for (TimeLine timeLineData : tls) {                                        //作業情報をJSONデータに格納する

          CompartmentStatus compartmentStatusData = FieldComprtnent.getCompartmentStatus(timeLineData.kukakuId);
          CompartmentWorkChainStatus cws          = compartmentStatusData.getWorkChainStatus();
          if (crop != 0 && crop != cws.cropId) {
            continue;
          }

          WorkDiary wd = WorkDiary.find.where().eq("work_diary_id", timeLineData.workDiaryId).findUnique();

          if (wd == null) { continue; }

          ObjectNode timeLineJson         = Json.newObject();
          timeLineJson.put("workPlanId"   , timeLineData.workDiaryId);                  //作業計画ID
          timeLineJson.put("workdate"     , sdf2.format(wd.workDate));                  //作業日
          timeLineJson.put("keydate"      , sdfp.format(wd.workDate));                  //キー作業日
          timeLineJson.put("message"      , StringU.setNullTrim(timeLineData.message)); //メッセージ
          timeLineJson.put("timeLineColor", timeLineData.timeLineColor);                //タイムラインカラー
          timeLineJson.put("workName"     , timeLineData.workName);                     //作業名
          timeLineJson.put("kukakuName"   , timeLineData.kukakuName);                   //区画名
          timeLineJson.put("accountId"    , timeLineData.accountId);                    //アカウントID
          timeLineJson.put("accountName"  , timeLineData.accountName);                  //アカウント名
          timeLineJson.put("workId"       , timeLineData.workId);                       //作業ＩＤ
          timeLineJson.put("worktime"     , wd.workTime);                               //作業時間
          timeLineJson.put("kukakuId"     , timeLineData.kukakuId);                     //区画ＩＤ
          Compartment cpt = Compartment.getCompartmentInfo(timeLineData.kukakuId);
          timeLineJson.put("fieldId"      , cpt.fieldId);                               //圃場ID
          timeLineJson.put("end"          , AgryeelConst.WORKPLANEND.END);              //作業完了フラグ
          timeLineJson.put("workPlanFlag" , timeLineData.workPlanFlag);                 //作業計画フラグ
          timeLineJson.put("uuidofday"    , timeLineData.uuidOfDay);                    //同一日内指示番号
          if(api){
            FieldGroup fg = cpt.getFieldGroupInfo();
            timeLineJson.put("kukakuColor", fg.fieldGroupColor);                        //区画カラー
          }

          idx++;
          workList.put(Double.toString(idx), timeLineJson);
          listJsonApi.add(timeLineJson);

        }

      } catch (ParseException e) {
        e.printStackTrace();
      }

      if(api){
        resultJson.put("planList", listJsonApi);
      }else{
        resultJson.put("dateList", dateList);
        resultJson.put("planList", workList);
      }
      return ok(resultJson);
    }
    /**
     * 【AICA】作業指示書(担当者別)の取得
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result getWorkPlanAccount(String targetDate, String accountId) {

      ObjectNode resultJson   = Json.newObject();
      ObjectNode accountList  = Json.newObject();
      ObjectNode workList     = Json.newObject();
      ObjectMapper mapper     = new ObjectMapper().enable(SerializationFeature.INDENT_OUTPUT);
      ArrayNode listJsonApi   = mapper.createArrayNode();
      boolean api             = false;

      //----------------------------------------------------------------------------
      //- 作業指示書を取得する
      //----------------------------------------------------------------------------
      SimpleDateFormat sdfp = new SimpleDateFormat("yyyyMMdd");
      SimpleDateFormat sdff = new SimpleDateFormat("yyyy/MM/dd");
      SimpleDateFormat sdf  = new SimpleDateFormat("MM.dd HH:mm");
      SimpleDateFormat sdf2 = new SimpleDateFormat("MM/dd");

      Calendar system   = Calendar.getInstance();
      Calendar start    = Calendar.getInstance();
      Calendar end      = Calendar.getInstance();
      try {

        String[] accountsp = accountId.split(",");
        List<String> accountKeys = new ArrayList<String>();
        for (String key : accountsp) {
          accountKeys.add(key);
        }

        UserComprtnent ac = new UserComprtnent();
        ac.GetAccountData(session(AgryeelConst.SessionKey.ACCOUNTID));
        List<Account> accounts = Account.find.where().eq("farm_id", ac.accountData.farmId).in("account_id", accountKeys).findList();

        Calendar cal = Calendar.getInstance();
        long to   = cal.getTime().getTime();

        int dIdx = 0;
        //------ 担当者未選択 -----
        dIdx++;
        ObjectNode accountJson = Json.newObject();
        accountJson.put("name"       , "担当者未選択");
        accountJson.put("keyaccount" , "");
        accountList.put(String.valueOf(dIdx), accountJson);
        //------ 担当者別-----
        for (Account account : accounts) {
          dIdx++;
          accountJson = Json.newObject();
          accountJson.put("name"       , account.acountName);
          accountJson.put("keyaccount" , account.accountId);
          accountList.put(String.valueOf(dIdx), accountJson);
        }

        start.setTime(sdfp.parse(targetDate));
        end.setTime(sdfp.parse(targetDate));

        if (session(AgryeelConst.SessionKey.API) != null) {
          api = true;
        }

        List<PlanLine> pls = PlanLine.getPlanLineOfAccount(accountId, ac.accountData.farmId, start.getTime(), end.getTime());
        int idx = 0;

        for (PlanLine planLineData : pls) {                                        //作業情報をJSONデータに格納する

          WorkPlan wp = WorkPlan.find.where().eq("work_plan_id", planLineData.workPlanId).findUnique();

          if (wp == null) { continue; }

          ObjectNode timeLineJson         = Json.newObject();
          timeLineJson.put("workPlanId"   , planLineData.workPlanId);                   //作業計画ID
          timeLineJson.put("workdate"     , sdf2.format(wp.workDate));                  //作業日
          timeLineJson.put("keyaccount"   , wp.accountId);                              //キーアカウントID
          timeLineJson.put("message"      , StringU.setNullTrim(planLineData.message)); //メッセージ
          timeLineJson.put("timeLineColor", planLineData.planLineColor);                //タイムラインカラー
          timeLineJson.put("workName"     , planLineData.workName);                     //作業名
          timeLineJson.put("kukakuName"   , planLineData.kukakuName);                   //区画名
          timeLineJson.put("accountId"    , planLineData.accountId);                    //アカウントID
          timeLineJson.put("accountName"  , planLineData.accountName);                  //アカウント名
          timeLineJson.put("workId"       , planLineData.workId);                       //作業ＩＤ
          timeLineJson.put("worktime"     , wp.workTime);                               //作業時間
          timeLineJson.put("kukakuId"     , planLineData.kukakuId);                     //区画ＩＤ
          Compartment cpt = Compartment.getCompartmentInfo(planLineData.kukakuId);
          timeLineJson.put("fieldId"      , cpt.fieldId);                               //圃場ID
          timeLineJson.put("end"          , AgryeelConst.WORKPLANEND.WORKPLAN);         //作業完了フラグ
          timeLineJson.put("workPlanFlag" , planLineData.workPlanFlag);                 //作業計画フラグ
          timeLineJson.put("uuidofday"    , planLineData.uuidOfDay);                    //同一日内指示番号
          if (planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKDIARYWATCH
              || planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKPLANWATCH
              || planLineData.workPlanFlag == AgryeelConst.WORKPLANFLAG.AICAPLANWATCH) {//作業中の場合

            long from = wp.workStartTime.getTime();
            long diff = ( to - from  ) / (1000 * 60 );
            timeLineJson.put("worktime"     , diff);                                    //作業時間を書き換える

          }
          if(api){
            FieldGroup fg = cpt.getFieldGroupInfo();
            timeLineJson.put("kukakuColor", fg.fieldGroupColor);                        //区画カラー
          }

          idx++;
          workList.put(Double.toString(idx), timeLineJson);
          listJsonApi.add(timeLineJson);

        }

        List<TimeLine> tls = TimeLine.getTimeLineOfAccount(accountId, ac.accountData.farmId, start.getTime(), end.getTime());

        for (TimeLine timeLineData : tls) {                                        //作業情報をJSONデータに格納する

          WorkDiary wd = WorkDiary.find.where().eq("work_diary_id", timeLineData.workDiaryId).findUnique();

          if (wd == null) { continue; }

          ObjectNode timeLineJson         = Json.newObject();
          timeLineJson.put("workPlanId"   , timeLineData.workDiaryId);                  //作業計画ID
          timeLineJson.put("workdate"     , sdf2.format(wd.workDate));                  //作業日
          timeLineJson.put("keyaccount"   , timeLineData.accountId);                    //キーアカウントID
          timeLineJson.put("message"      , StringU.setNullTrim(timeLineData.message)); //メッセージ
          timeLineJson.put("timeLineColor", timeLineData.timeLineColor);                //タイムラインカラー
          timeLineJson.put("workName"     , timeLineData.workName);                     //作業名
          timeLineJson.put("kukakuName"   , timeLineData.kukakuName);                   //区画名
          timeLineJson.put("accountId"    , timeLineData.accountId);                    //アカウントID
          timeLineJson.put("accountName"  , timeLineData.accountName);                  //アカウント名
          timeLineJson.put("workId"       , timeLineData.workId);                       //作業ＩＤ
          timeLineJson.put("worktime"     , wd.workTime);                               //作業時間
          timeLineJson.put("kukakuId"     , timeLineData.kukakuId);                     //区画ＩＤ
          Compartment cpt = Compartment.getCompartmentInfo(timeLineData.kukakuId);
          timeLineJson.put("fieldId"      , cpt.fieldId);                               //圃場ID
          timeLineJson.put("end"          , AgryeelConst.WORKPLANEND.END);              //作業完了フラグ
          timeLineJson.put("workPlanFlag" , timeLineData.workPlanFlag);                 //作業計画フラグ
          timeLineJson.put("uuidofday"    , timeLineData.uuidOfDay);                    //同一日内指示番号
          if(api){
            FieldGroup fg = cpt.getFieldGroupInfo();
            timeLineJson.put("kukakuColor", fg.fieldGroupColor);                        //区画カラー
          }

          idx++;
          workList.put(Double.toString(idx), timeLineJson);
          listJsonApi.add(timeLineJson);

        }

      } catch (ParseException e) {
        e.printStackTrace();
      }

      if(api){
        resultJson.put("planList", listJsonApi);
      }else{
        resultJson.put("accountList", accountList);
        resultJson.put("planList", workList);
      }
      return ok(resultJson);
    }
    /**
     * 【AICA】作業指示書の作業開始
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result startWorkPlan(double workPlanId) {

      ObjectNode resultJson   = Json.newObject();
      SimpleDateFormat sdf = new SimpleDateFormat("yy/MM/dd HH:mm");
      SimpleDateFormat sdfp = new SimpleDateFormat("yyyyMMdd");

      //----------------------------------------------------------------------------
      //- 作業指示書を作業開始の状態とする
      //----------------------------------------------------------------------------
      UserComprtnent accountComprtnent = new UserComprtnent();
      int getAccount = accountComprtnent.GetAccountData(session(AgryeelConst.SessionKey.ACCOUNTID));
      Account ac = accountComprtnent.accountData;

      WorkPlan wp = WorkPlan.getWorkPlanById(workPlanId);

      if (wp != null) {

        Calendar system = Calendar.getInstance();
        Compartment compartment = Compartment.find.where().eq("kukaku_id", wp.kukakuId).findUnique();   //区画情報モデルの取得

        if ((wp.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKPLANCOMMIT) || (wp.workPlanFlag == AgryeelConst.WORKPLANFLAG.AICAPLANCOMMIT)) {
          wp.workDate = new java.sql.Date(system.getTimeInMillis());
          wp.workStartTime = new java.sql.Timestamp(system.getTimeInMillis());
          if ((wp.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKPLANCOMMIT)) {
            wp.workPlanFlag = AgryeelConst.WORKPLANFLAG.WORKPLANWATCH;
          }
          else {
            wp.workPlanFlag = AgryeelConst.WORKPLANFLAG.AICAPLANWATCH;
          }
          wp.update();
          PlanLine pl = PlanLine.find.where().eq("work_plan_id", workPlanId).findUnique();
          if (pl != null) {
            if ((pl.workPlanFlag == AgryeelConst.WORKPLANFLAG.WORKPLANCOMMIT) || (pl.workPlanFlag == AgryeelConst.WORKPLANFLAG.AICAPLANCOMMIT)) {
              if (wp.workStartTime != null) {
                pl.message += "【 開始時間 】 " + sdf.format(wp.workStartTime);
              }
              pl.workDate = wp.workDate;
              pl.workPlanFlag = wp.workPlanFlag;
              pl.update();
              resultJson.put("keydate", sdfp.format(pl.workDate));                  //キー作業日
              resultJson.put("message"  , pl.message);
            }
          }
        }


        ac.workId         = wp.workId;
        ac.fieldId        = compartment.kukakuId;
        ac.workStartTime  = new java.sql.Timestamp(system.getTimeInMillis());
        ac.workPlanId     = wp.workPlanId;
        ac.update();

        Compartment ct = Compartment.getCompartmentInfo(ac.fieldId);
        Work        wk = Work.getWork(ac.workId);

        Logger.info("[ WORKING START ] ID:{} NAME:{} KUKAKUID:{} KUKAKUNAME:{} WORKID:{} WORKNAME:{} STARTTIME:{}", ac.accountId, ac.acountName, ct.kukakuId, ct.kukakuName, wk.workId, wk.workName, sdf.format(ac.workStartTime));

        session(AgryeelConst.SessionKey.WORKING_ACTION, "display");
        accountComprtnent.getAccountJson(resultJson);
      }
      else {

      }

      return ok(resultJson);
    }
    /**
     * 【AICA】作業指示書の担当者変更
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result tantouChange(double workPlanId, String accountId) {

      ObjectNode resultJson   = Json.newObject();

      WorkPlan wp = WorkPlan.getWorkPlanById(workPlanId);

      if (wp != null) {
        wp.accountId = accountId;
        wp.update();

        PlanLine pl = PlanLine.find.where().eq("work_plan_id", workPlanId).findUnique();
        if (pl != null) {

          Account ac = Account.getAccount(accountId);

          pl.accountId    = accountId;
          pl.accountName  = ac.acountName;
          pl.update();

          Logger.info("[ WORK PLAN TANTOU CHANGE ] ID:{} NAME:{}", ac.accountId, ac.acountName);
          resultJson.put("id"     , pl.accountId);
          resultJson.put("name"   , pl.accountName);
          resultJson.put("result" , AgryeelConst.Result.SUCCESS);

        }
        else {
          resultJson.put("result" , AgryeelConst.Result.ERROR);
        }
      }
      else {
        resultJson.put("result" , AgryeelConst.Result.ERROR);
      }

      return ok(resultJson);
    }
    /**
     * 【AICA】作業指示書の作業日を変更する
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result workDateChange(double workPlanId, String workDate) {

      ObjectNode resultJson   = Json.newObject();
      SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
      Calendar cal = Calendar.getInstance();

      WorkPlan wp = WorkPlan.getWorkPlanById(workPlanId);

      if (wp != null) {
        try {
          cal.setTime(sdf.parse((workDate)));
        } catch (ParseException e) {
          e.printStackTrace();
        }
        wp.workDate = new java.sql.Date(cal.getTimeInMillis());
        wp.update();

        PlanLine pl = PlanLine.find.where().eq("work_plan_id", workPlanId).findUnique();
        if (pl != null) {

          pl.workDate = wp.workDate;
          pl.update();

          Logger.info("[ WORK PLAN WORKDATE CHANGE ] DATE:{}", sdf.format(pl.workDate));
          resultJson.put("result" , AgryeelConst.Result.SUCCESS);

        }
        else {
          resultJson.put("result" , AgryeelConst.Result.ERROR);
        }
      }
      else {
        resultJson.put("result" , AgryeelConst.Result.ERROR);
      }

      return ok(resultJson);
    }
    /**
     * 【AICA】作業指示書の削除
     */
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result workPlanDelete(double workPlanId) {

      ObjectNode resultJson   = Json.newObject();

      Ebean.createSqlUpdate("DELETE FROM work_plan WHERE work_plan_id = :workPlanId")
      .setParameter("workPlanId", workPlanId).execute();

      Ebean.createSqlUpdate("DELETE FROM work_plan_sanpu WHERE work_plan_id = :workPlanId")
      .setParameter("workPlanId", workPlanId).execute();

      Ebean.createSqlUpdate("DELETE FROM plan_line WHERE work_plan_id = :workPlanId")
      .setParameter("workPlanId", workPlanId).execute();

      Ebean.createSqlUpdate("DELETE FROM work_plan_detail WHERE work_plan_id = :workPlanId")
      .setParameter("workPlanId", workPlanId).execute();

      Logger.info("[ WORK PLAN DELETE ] PLANID:{}", workPlanId);
      resultJson.put("result" , AgryeelConst.Result.SUCCESS);

      return ok(resultJson);
    }
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result workPlanCopy(double workPlanId, double kukakuId) {
      ObjectNode resultJson = Json.newObject();

      //----------------------------------------------------------------------------
      //- 目標収穫量の更新
      //----------------------------------------------------------------------------
      JsonNode input = request().body().asJson();
      SimpleDateFormat sdfp = new SimpleDateFormat("yyyy/MM/dd");
      SimpleDateFormat sdfu = new SimpleDateFormat("yyyyMMddHHmmssSSS");
      DecimalFormat    df   = new DecimalFormat("000000");


      try {
        Ebean.beginTransaction();

        UserComprtnent ac = new UserComprtnent();
        ac.GetAccountData(session(AgryeelConst.SessionKey.ACCOUNTID));

        Calendar system = Calendar.getInstance();

        WorkPlan wp = WorkPlan.getWorkPlanById(workPlanId);
        if (wp != null) {
          //----- 作業計画の自動作成 -----
          WorkPlan workplan = new WorkPlan();
          Sequence sequence     = Sequence.GetSequenceValue(Sequence.SequenceIdConst.WORKPLANID); //最新シーケンス値の取得
          double nworkPlanId    = sequence.sequenceValue;
          workplan.workPlanId          = nworkPlanId;
          workplan.workId              = wp.workId;
          workplan.kukakuId            = kukakuId;
          workplan.hillId              = wp.hillId;
          workplan.lineId              = wp.lineId;
          workplan.stockId             = wp.stockId;
          workplan.accountId           = "";
          workplan.workDate            = wp.workDate;
          workplan.workTime            = wp.workTime;
          workplan.shukakuRyo          = wp.shukakuRyo;
          workplan.detailSettingKind   = wp.detailSettingKind;
          workplan.combiId             = wp.combiId;
          workplan.kikiId              = wp.kikiId;
          workplan.attachmentId        = wp.attachmentId;
          workplan.hinsyuId            = wp.hinsyuId;
          workplan.beltoId             = wp.beltoId;
          workplan.kabuma              = wp.kabuma;
          workplan.joukan              = wp.joukan;
          workplan.jousu               = wp.jousu;
          workplan.hukasa              = wp.hukasa;
          workplan.kansuiPart          = wp.kansuiPart;
          workplan.kansuiSpace         = wp.kansuiSpace;
          workplan.kansuiMethod        = wp.kansuiMethod;
          workplan.kansuiRyo           = wp.kansuiRyo;
          workplan.syukakuNisugata     = wp.syukakuNisugata;
          workplan.syukakuSitsu        = wp.syukakuSitsu;
          workplan.syukakuSize         = wp.syukakuSize;
          workplan.kukakuStatusUpdate  = wp.kukakuStatusUpdate;
          workplan.motochoUpdate       = wp.motochoUpdate;
          workplan.workRemark          = wp.workRemark;
          workplan.workStartTime       = wp.workStartTime;
          workplan.workEndTime         = wp.workEndTime;
          workplan.numberOfSteps       = 0;
          workplan.distance            = 0;
          workplan.calorie             = 0;
          workplan.heartRate           = 0;
          workplan.useMulti            = wp.useMulti;
          workplan.retusu              = wp.retusu;
          workplan.naemaisu            = wp.naemaisu;
          workplan.useHole             = wp.useHole;
          workplan.maisu               = wp.maisu;
          workplan.useBaido            = wp.useBaido;
          workplan.senteiHeight        = wp.senteiHeight;
          workplan.workPlanFlag        = AgryeelConst.WORKPLANFLAG.WORKPLANCOMMIT;
          workplan.workPlanUUID        = df.format(ac.accountData.farmId) + sdfu.format(system.getTime()) + ac.accountData.accountId;
          workplan.shitateHonsu        = wp.shitateHonsu;
          workplan.nicho               = wp.nicho;

          workplan.save();

          //----- 作業散布計画の自動作成 -----
          List<models.WorkPlanSanpu> wpss = models.WorkPlanSanpu.find.where().eq("work_plan_id", wp.workPlanId).orderBy("work_diary_sequence asc").findList();
          int workDiarySequence = 0;
          for (models.WorkPlanSanpu wps : wpss) {
            models.WorkPlanSanpu nwps = new WorkPlanSanpu();

            workDiarySequence++;
            nwps.workPlanId          = nworkPlanId;
            nwps.workDiarySequence   = workDiarySequence;
            nwps.sanpuMethod         = wps.sanpuMethod;
            nwps.kikiId              = wps.kikiId;
            nwps.attachmentId        = wps.attachmentId;
            nwps.nouhiId             = wps.nouhiId;
            nwps.bairitu             = wps.bairitu;
            nwps.sanpuryo            = wps.sanpuryo;
            nwps.kukakuStatusUpdate  = wps.kukakuStatusUpdate;
            nwps.motochoUpdate       = wps.motochoUpdate;
            nwps.save();
          }

          //----- 作業詳細計画の自動作成 -----
          List<models.WorkPlanDetail> wpds = models.WorkPlanDetail.find.where().eq("work_plan_id", wp.workPlanId).orderBy("work_diary_sequence asc").findList();
          workDiarySequence = 0;
          for (models.WorkPlanDetail wpd : wpds) {
            models.WorkPlanDetail nwpd = new WorkPlanDetail();

            workDiarySequence++;
            nwpd.workPlanId          = nworkPlanId;
            nwpd.workDiarySequence   = workDiarySequence;
            nwpd.workDetailKind      = wpd.workDetailKind;
            nwpd.suryo               = wpd.suryo;
            nwpd.sizaiId             = wpd.sizaiId;
            nwpd.comment             = wpd.comment;
            nwpd.syukakuNisugata     = wpd.syukakuNisugata;
            nwpd.syukakuSitsu        = wpd.syukakuSitsu;
            nwpd.syukakuSize         = wpd.syukakuSize;
            nwpd.syukakuKosu         = wpd.syukakuKosu;
            nwpd.shukakuRyo          = wpd.shukakuRyo;
            nwpd.syukakuHakosu       = wpd.syukakuHakosu;
            nwpd.syukakuNinzu        = wpd.syukakuNinzu;
            nwpd.save();
          }

          /* -- プランラインを作成する -- */
          Work work = Work.find.where().eq("work_id", workplan.workId).findUnique();                       //作業情報モデルの取得
          PlanLine planLine = new PlanLine();                                       //タイムラインモデルの生成
          Compartment compartment = Compartment.find.where().eq("kukaku_id", workplan.kukakuId).findUnique();   //区画情報モデルの取得

          planLine.workPlanId = workplan.workPlanId;

          planLine.updateTime       = DateU.getSystemTimeStamp();
          planLine.message        = "【" + work.workName + "情報】<br>";
          switch ((int)work.workTemplateId) {
          case AgryeelConst.WorkTemplate.NOMAL:
            planLine.message        += "";                                 //メッセージ
            break;
          case AgryeelConst.WorkTemplate.SANPU:

            List<WorkPlanSanpu> wpssp = WorkPlanSanpu.getWorkPlanSanpuList(workplan.workPlanId);

            for (WorkPlanSanpu wps : wpssp) {

              /* 農肥IDから農肥情報を取得する */
              Nouhi nouhi = Nouhi.find.where().eq("nouhi_id",  wps.nouhiId).findUnique();

              String sanpuName  = "";

              if (wps.sanpuMethod != 0) {
                  sanpuName = "&nbsp;&nbsp;&nbsp;&nbsp;[" + Common.GetCommonValue(Common.ConstClass.SANPUMETHOD, wps.sanpuMethod) + "]";
              }

              String unit = nouhi.getUnitString();

              planLine.message        +=  nouhi.nouhiName + "&nbsp;&nbsp;" + nouhi.bairitu + "倍&nbsp;&nbsp;" + df.format(wps.sanpuryo * nouhi.getUnitHosei()) + unit + sanpuName + "<br>";
              planLine.message       +=  "--------------------------------------------------<br>";

            }

            break;
          case AgryeelConst.WorkTemplate.HASHU:
            planLine.message       += "<品種> " + Hinsyu.getMultiHinsyuName(workplan.hinsyuId) + "<br>";
            planLine.message       += "<株間> " + workplan.kabuma + "cm<br>";
            planLine.message       += "<条間> " + workplan.joukan + "cm<br>";
            planLine.message       += "<条数> " + workplan.jousu  + "cm<br>";
            planLine.message       += "<深さ> " + workplan.hukasa + "cm<br>";
            planLine.message       += "<機器> " + Kiki.getKikiName(workplan.kikiId) + "<br>";
            planLine.message       += "<アタッチメント> " + Attachment.getAttachmentName(workplan.attachmentId) + "<br>";
            planLine.message       += "<ベルト> " + Belto.getBeltoName(workplan.beltoId) + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.SHUKAKU:
            List<WorkPlanDetail> wpdsp = WorkPlanDetail.getWorkPlanDetailList(workplan.workPlanId);
            int idx = 0;
            for (WorkPlanDetail wpd : wpdsp) {
              if (wpd.shukakuRyo == 0) {
                continue;
              }
              idx++;
              planLine.message       += "<荷姿" + idx + "> "     + Nisugata.getNisugataName(wpd.syukakuNisugata) + "<br>";
              planLine.message       += "<質" + idx + "> "       + Shitu.getShituName(wpd.syukakuSitsu) + "<br>";
              planLine.message       += "<サイズ" + idx + "> "   + Size.getSizeName(wpd.syukakuSize) + "<br>";
              planLine.message       += "<個数" + idx + "> "   + wpd.syukakuKosu + "個" + "<br>";
              planLine.message       += "<収穫量" + idx + "> "   + wpd.shukakuRyo + "Kg" + "<br>";
              planLine.message       +=  "--------------------------------------------------<br>";

            }
            if (idx == 0) {
              planLine.message       += "<荷姿> "     + Nisugata.getNisugataName(workplan.syukakuNisugata) + "<br>";
              planLine.message       += "<質> "       + Shitu.getShituName(workplan.syukakuSitsu) + "<br>";
              planLine.message       += "<サイズ> "   + Size.getSizeName(workplan.syukakuSize) + "<br>";
              planLine.message       += "<収穫量> "   + workplan.shukakuRyo + "Kg" + "<br>";
              planLine.message       +=  "--------------------------------------------------<br>";
            }
            break;
          case AgryeelConst.WorkTemplate.NOUKO:
            planLine.message       += "<機器> " + Kiki.getKikiName(workplan.kikiId) + "<br>";
            planLine.message       += "<アタッチメント> " + Attachment.getAttachmentName(workplan.attachmentId) + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.KANSUI:
            planLine.message       += "<潅水方法> " + Common.GetCommonValue(Common.ConstClass.KANSUI, workplan.kansuiMethod) + "<br>";
            planLine.message       += "<機器> " + Kiki.getKikiName(workplan.kikiId) + "<br>";
            planLine.message       += "<潅水量> " + workplan.kansuiRyo + "L" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.KAISHU:
            wpds = WorkPlanDetail.getWorkPlanDetailList(workplan.workPlanId);
            idx = 0;
            for (WorkPlanDetail wpd : wpds) {
              idx++;
              planLine.message        +=  "<数量" + idx + ">" + "&nbsp;&nbsp;" + wpd.suryo + "個<br>";

            }
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.DACHAKU:
            wpds = WorkPlanDetail.getWorkPlanDetailList(workplan.workPlanId);
            idx = 0;
            for (WorkPlanDetail wpd : wpds) {
              idx++;
              planLine.message        +=  "<資材" + idx + ">" + "&nbsp;&nbsp;" + Common.GetCommonValue(Common.ConstClass.ITOSIZAI, (int)wpd.sizaiId, true) + "<br>";

            }
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.COMMENT:
            wpds = WorkPlanDetail.getWorkPlanDetailList(workplan.workPlanId);
            idx = 0;
            for (WorkPlanDetail wpd : wpds) {
              idx++;
              planLine.message        +=  "<コメント" + idx + ">" + "&nbsp;&nbsp;" + wpd.comment + "<br>";

            }
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.MALTI:
            planLine.message       += "<使用マルチ> " + Common.GetCommonValue(Common.ConstClass.ITOMULTI, (int)workplan.useMulti, true) + "<br>";
            planLine.message       += "<列数> " + workplan.retusu + "列" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.TEISHOKU:
            planLine.message       += "<使用苗枚数> " + workplan.naemaisu + "枚" + "<br>";
            planLine.message       += "<列数> " + workplan.retusu + "列" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.NAEHASHU:
            planLine.message       += "<使用穴数> " + workplan.useHole + "穴" + "<br>";
            planLine.message       += "<枚数> " + workplan.maisu + "枚" + "<br>";
            planLine.message       += "<使用培土> " + Common.GetCommonValue(Common.ConstClass.ITOBAIDO, (int)workplan.useBaido, true) + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.SENTEI:
            planLine.message       += "<剪定高> " + workplan.senteiHeight + "cm" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.MABIKI:
            planLine.message       += "<仕立本数> " + workplan.shitateHonsu + "本" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.NICHOCHOSEI:
            planLine.message       += "<日長> " + workplan.nicho + "時間" + "<br>";
            planLine.message       +=  "--------------------------------------------------<br>";
            break;
          case AgryeelConst.WorkTemplate.SENKA:
            wpdsp = WorkPlanDetail.getWorkPlanDetailList(workplan.workPlanId);
            idx = 0;
            for (WorkPlanDetail wpd : wpdsp) {
              if (wpd.syukakuKosu == 0 && wpd.syukakuHakosu == 0) {
                continue;
              }
              idx++;
              planLine.message       += "<等級" + idx + "> "       + Shitu.getShituName(wpd.syukakuSitsu) + "<br>";
              planLine.message       += "<階級" + idx + "> "   + Size.getSizeName(wpd.syukakuSize) + "<br>";
              planLine.message       += "<箱数" + idx + "> "   + wpd.syukakuHakosu + "ケース" + "<br>";
              planLine.message       += "<本数" + idx + "> "   + wpd.syukakuKosu + "本" + "<br>";
              planLine.message       += "<人数" + idx + "> "   + wpd.syukakuNinzu + "人" + "<br>";
              planLine.message       += "<収穫量" + idx + "> " + wpd.shukakuRyo + "Kg" + "<br>";
              planLine.message       +=  "--------------------------------------------------<br>";

            }
            break;
          }

          planLine.planLineColor  = work.workColor;                             //プランラインカラー
          planLine.workId         = work.workId;                                    //作業ID
          planLine.workName       = work.workName;                                  //作業名
          planLine.workDate       = workplan.workDate;                              //作業日
          planLine.kukakuId       = compartment.kukakuId;                           //区画ID
          planLine.kukakuName     = compartment.kukakuName;                         //区画名
          planLine.accountId      = "";                                             //アカウントＩＤ
          planLine.accountName    = "担当者未選択";                                    //アカウント名
          planLine.farmId         = ac.accountData.farmId;                          //農場ID
          planLine.workPlanFlag   = workplan.workPlanFlag;                          //作業計画フラグ
          planLine.workPlanUUID   = workplan.workPlanUUID;                          //作業計画UUID

          planLine.save();                                                          //タイムラインを追加

        }

        Ebean.commitTransaction();
        resultJson.put("result"   , "SUCCESS");
      }
      catch (Exception ex) {
        Logger.error("[commitPlanWork] Save Error.", ex);
        ex.printStackTrace();
        Ebean.rollbackTransaction();
        resultJson.put("result"   , "ERROR");
      }


      return ok(resultJson);
    }
    @Security.Authenticated(SessionCheckComponent.class)
    public static Result workPlanUuidOnDayChange() {

      ObjectNode  resultJson = Json.newObject();

      try {
        Ebean.beginTransaction();
        JsonNode input = request().body().asJson();
        JsonNode datalist = input.get("dataList");

        for (JsonNode info : datalist) {
          double id = info.get("id").asDouble();
          int uuid  = info.get("uuid").asInt();
          int type  = info.get("type").asInt();

          if (type == 0) { //Planの場合
            PlanLine pl = PlanLine.find.where().eq("work_plan_id", id).findUnique();
            if (pl != null) {
              pl.uuidOfDay = uuid;
              pl.update();
              WorkPlan wp = WorkPlan.getWorkPlanById(id);
              if (wp != null) {
                wp.uuidOfDay = uuid;
                wp.update();
              }
            }
          }
          else { //Diaryの場合
            TimeLine tl = TimeLine.find.where().eq("work_diary_id", id).findUnique();
            if (tl != null) {
              tl.uuidOfDay = uuid;
              tl.update();
              WorkDiary wd = WorkDiary.getWorkDiaryById(id);
              if (wd != null) {
                wd.uuidOfDay = uuid;
                wd.update();
              }
            }
          }

        }

        Ebean.commitTransaction();
      }
      catch (Exception ex) {
        Logger.error("[workPlanUuidOnDayChange] Update Error.", ex);
        ex.printStackTrace();
        Ebean.rollbackTransaction();
      }

      resultJson.put(AgryeelConst.Result.RESULT, AgryeelConst.Result.SUCCESS);

      return ok(resultJson);
    }
}
